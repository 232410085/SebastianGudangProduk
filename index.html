<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Penjualan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #E7E7E7; 
    }
    h1 {
      color: #000000;
      font-weight: bold;
    }
    .card {
      border: 2px solid #616161; 
      background-color: #FFFFFF;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(1,0,0,1);
    }
    .btn-primary {
      background-color: #303030;
      border-color: #303030;
    }
    .btn-primary:hover {
      background-color: #C2C2C2;
      border-color: #C2C2C2;
    }
    .btn-success {
      background-color: #1c1c1c;
      border-color: #1c1c1c;
    }
    .btn-success:hover {
      background-color: #C2C2C2;
      border-color: #C2C2C2;
    }
    .btn-danger {
      background-color #dc3545;
      border-color: #dc3545;
    }
    .table thead {
      background-color: #1c1c1c;
      color: #fff;
    }
    .table tfoot {
      background-color: #e9ecef;
      font-weight: bold;
    }
    .nama-user {
      font-weight: bold;
      color: #303030;
    }
  </style>
</head>

<body>

<div class="container py-4">
  <h1 class="mb-4 text-center"> Transaksi Penjualan</h1>

  <!-- Form Input -->
  <div class="card p-3 mb-4">
    <div class="row g-2 align-items-center">
      <div class="col-md-4">
        <select id="produk" class="form-select" onchange="tampilHarga()">
          <option value="">Pilih Produk</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" id="jumlah" class="form-control" placeholder="Jumlah">
      </div>
      <div class="col-md-2">
        <input type="text" id="harga" class="form-control" placeholder="Harga" readonly>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" onclick="tambahDetail()">Tambah</button>
      </div>
    </div>
  </div>

  <!-- Tabel Keranjang -->
  <div class="card p-3">
    <h5>ðŸ›’ Keranjang</h5>
    <table class="table table-bordered bg-white">
      <thead>
        <tr>
          <th>Produk</th>
          <th>Jumlah</th>
          <th>Harga</th>
          <th>Subtotal</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="keranjang"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-end"><strong>Total</strong></td>
          <td colspan="2"><strong>Rp <span id="total">0</span></strong></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Simpan -->
  <div class="d-flex align-items-center mt-3 gap-3">
    <button class="btn btn-success" onclick="simpanTransaksi()">Simpan Transaksi</button>
    <span class="nama-user">Sebastian Maximus Chandra</span>
  </div>

  <!-- Riwayat Transaksi -->
  <div class="card p-3 mt-4">
    <h5>ðŸ“œ Riwayat Transaksi</h5>
    <table class="table table-bordered bg-white">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tanggal</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="riwayat"></tbody>
    </table>
  </div>
</div>

<script>
  // Supabase setup
  const SUPABASE_URL = "https://vnhoxnxjgdxseofcygbv.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaG94bnhqZ2R4c2VvZmN5Z2J2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MzQ5NTcsImV4cCI6MjA3NDIxMDk1N30.lvp_UBD8-kP2jU-pPQHocwx1T7clYB40xWkCics0jq8"; 
  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let produkList = [];
  let keranjang = [];
  let total = 0;

  async function loadProduk() {
    const { data, error } = await db.from("produk").select("*").order("nama", { ascending: true });
    if (error) {
      Swal.fire("Error", "Gagal memuat produk: " + error.message, "error");
      return;
    }
    produkList = data;
    let select = document.getElementById("produk");
    select.innerHTML = '<option value="">Pilih Produk</option>'; // reset
    data.forEach(p => {
      let opt = document.createElement("option");
      opt.value = p.id;
      opt.setAttribute("data-harga", p.harga);
      opt.setAttribute("data-stok", p.stok);
      opt.textContent = `${p.nama} (Stok: ${p.stok})`;
      select.appendChild(opt);
    });
  }

  function tampilHarga() {
    let produk = document.getElementById("produk");
    let harga = produk.options[produk.selectedIndex].getAttribute("data-harga") || "";
    document.getElementById("harga").value = harga;
  }

  function tambahDetail() {
    let produk = document.getElementById("produk");
    let id_produk = produk.value;
    let nama = produk.options[produk.selectedIndex].text;
    let harga = parseFloat(document.getElementById("harga").value);
    let jumlah = parseInt(document.getElementById("jumlah").value);
    let stok = parseInt(produk.options[produk.selectedIndex].getAttribute("data-stok"));

    if (!id_produk || !harga || !jumlah) {
      Swal.fire("Oops!", "Pilih produk dan isi jumlah", "warning");
      return;
    }

    if (jumlah > stok) {
      Swal.fire("Oops!", "Jumlah melebihi stok yang tersedia!", "warning");
      return;
    }

    let subtotal = harga * jumlah;
    keranjang.push({ id_produk, nama, harga, jumlah, subtotal });
    total += subtotal;
    renderKeranjang();

    document.getElementById("jumlah").value = "";
  }

  function hapusItem(index) {
    total -= keranjang[index].subtotal;
    keranjang.splice(index, 1);
    renderKeranjang();
  }

  function renderKeranjang() {
    let tbody = document.getElementById("keranjang");
    tbody.innerHTML = "";
    keranjang.forEach((item, i) => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.nama}</td>
        <td>${item.jumlah}</td>
        <td>Rp ${item.harga.toLocaleString()}</td>
        <td>Rp ${item.subtotal.toLocaleString()}</td>
        <td><button class="btn btn-danger btn-sm" onclick="hapusItem(${i})">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("total").textContent = total.toLocaleString();
  }

  async function simpanTransaksi() {
    if (keranjang.length === 0) {
      Swal.fire("Oops!", "Keranjang masih kosong", "warning");
      return;
    }

    // Simpan header penjualan
    const { data: penjualan, error: err1 } = await db.from("penjualan").insert([{ 
      tanggal: new Date().toISOString(), 
      total 
    }]).select("id").single();

    if (err1) {
      Swal.fire("Error", "Gagal simpan penjualan: " + err1.message, "error");
      return;
    }

    let id_penjualan = penjualan.id;

    // Simpan detail penjualan
    let detailInsert = keranjang.map(d => ({
      id_penjualan,
      id_produk: d.id_produk,
      jumlah: d.jumlah,
      harga: d.harga,
      subtotal: d.subtotal
    }));

    const { error: err2 } = await db.from("penjualan_detail").insert(detailInsert);
    if (err2) {
      Swal.fire("Error", "Gagal simpan detail: " + err2.message, "error");
      return;
    }

    // Update stok produk
    for (let d of keranjang) {
      const { data: produk, error: errFetch } = await db
        .from("produk")
        .select("stok")
        .eq("id", d.id_produk)
        .single();

      if (errFetch) {
        Swal.fire("Error", "Gagal ambil stok produk: " + errFetch.message, "error");
        return;
      }

      let stokBaru = produk.stok - d.jumlah;
      if (stokBaru < 0) stokBaru = 0;

      const { error: errUpdate } = await db
        .from("produk")
        .update({ stok: stokBaru })
        .eq("id", d.id_produk);

      if (errUpdate) {
        Swal.fire("Error", "Gagal update stok: " + errUpdate.message, "error");
        return;
      }
    }

    Swal.fire("Sukses", "Transaksi berhasil disimpan", "success");
    keranjang = [];
    total = 0;
    renderKeranjang();
    loadProduk();   // refresh stok di dropdown
    loadRiwayat();  // refresh riwayat
  }

  async function loadRiwayat() {
    const { data, error } = await db.from("penjualan").select("*").order("tanggal", { ascending: false });
    if (error) {
      Swal.fire("Error", "Gagal memuat riwayat: " + error.message, "error");
      return;
    }

    let tbody = document.getElementById("riwayat");
    tbody.innerHTML = "";

    data.forEach(trx => {
      let tr = document.createElement("tr");
      let tanggal = new Date(trx.tanggal).toLocaleString("id-ID");
      tr.innerHTML = `
        <td>${trx.id}</td>
        <td>${tanggal}</td>
        <td>Rp ${trx.total.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  loadProduk();
  loadRiwayat();
</script>

</body>
</html>

